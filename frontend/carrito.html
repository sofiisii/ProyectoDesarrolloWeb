<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - Sabor Lime침o</title>
    <style>
        :root {
            --azul-pacifico: #1E88E5; --azul-pacifico-oscuro: #1565C0; --azul-pacifico-claro: #64B5F6;
            --aji-amarillo: #FFC107; --terracota: #BF360C; --verde-menta: #4CAF50;
            --verde-menta-oscuro: #388E3C; --purpura-nazca: #6A1B9A; --blanco-roto: #F8F9FA; --gris-texto: #424242;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--blanco-roto); margin: 0; padding: 0; color: var(--gris-texto); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); padding: 1rem 0; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 700; }
        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: all 0.3s; padding: 0.5rem 1rem; border-radius: 25px; }
        .nav-links a:hover { background-color: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
        .auth-buttons { display: flex; gap: 1rem; align-items: center; }
        .user-info { color: white; margin-right: 15px; font-weight: 500; }
        .btn { padding: 10px 20px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 14px; }
        .btn-outline { background: transparent; border: 2px solid white; color: white; }
        .btn-outline:hover { background: white; color: var(--azul-pacifico); }
        .btn-primary { background: var(--aji-amarillo); color: var(--azul-pacifico-oscuro); font-weight: 700; }
        .btn-primary:hover { background: #FFB300; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); }
        .hero { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-claro) 100%); color: white; padding: 2rem 0; text-align: center; margin-bottom: 2rem; }
        .hero h1 { font-size: 2rem; margin-bottom: 0.5rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .hero p { font-size: 1rem; opacity: 0.9; color: white; }
        .cart-layout { display: flex; justify-content: center; gap: 30px; max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .cart-column { background-color: white; border-radius: 15px; box-shadow: 0 8px 25px rgba(30, 136, 229, 0.1); width: 100%; max-width: 800px; padding: 30px; border: 2px solid transparent; }
        .cart-column h2 { font-size: 20px; font-weight: 600; color: var(--azul-pacifico-oscuro); margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--azul-pacifico-claro); }
        #cart-items { list-style: none; padding: 0; }
        #cart-items li { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--blanco-roto); font-weight: 500; }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-size: 1.1rem; color: var(--azul-pacifico-oscuro); }
        .item-price { font-size: 0.9rem; color: var(--gris-texto); }
        .item-controls { display: flex; align-items: center; gap: 10px; }
        .item-quantity { font-weight: 700; font-size: 1.1rem; min-width: 20px; text-align: center; }
        .btn-cart { padding: 10px 18px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px; color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .btn-cart:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2); }
        .remove-btn { background: linear-gradient(135deg, var(--terracota), #D84315); font-size: 12px; padding: 8px 12px; }
        .remove-btn:hover { background: linear-gradient(135deg, #D84315, var(--terracota)); }
        .btn-qty { background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); font-size: 12px; padding: 5px 10px; }
        #cart-summary { margin-top: 25px; }
        .total-row { display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: 700; color: var(--azul-pacifico-oscuro); padding: 1.5rem 0; border-top: 2px solid var(--azul-pacifico); }
        .btn-checkout { padding: 15px; border-radius: 8px; font-size: 16px; width: 100%; background: linear-gradient(135deg, var(--verde-menta), var(--verde-menta-oscuro)); color: white; text-decoration: none; text-align: center; display: block; }
        .btn-checkout:hover { background: linear-gradient(135deg, var(--verde-menta-oscuro), var(--verde-menta)); transform: translateY(-2px); }
        #empty-cart-message { text-align: center; padding: 2rem; color: var(--gris-texto); font-weight: 500; }
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <nav class="nav-container">
                <div class="logo"><span>Sabor Lime침o</span></div>
                <ul class="nav-links">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="catalogo.html">Cat치logo</a></li>
                    <li><a href="pedido.html">Mis Pedidos</a></li>
                    <li>
                        <a href="carrito.html" style="color: var(--aji-amarillo); font-weight: 700;">
                            Carrito 游
                        </a>
                    </li>
                </ul>
                <div class="auth-buttons">
                    </div>
            </nav>
        </div>
    </header>
    <section class="hero">
        <div class="container">
            <h1>Haz tu Pedido</h1>
            <p>Agrega o quita platos de tu carrito con flexibilidad</p>
        </div>
    </section>

    <div class="cart-layout">
        <div class="cart-column">
            <h2>Mi Carrito</h2>
            <ul id="cart-items">
                </ul>
            <div id="empty-cart-message" style="display: none;">
                Tu carrito est치 vac칤o. <a href="catalogo.html">춰Ve al cat치logo!</a>
            </div>
            
            <div id="cart-summary" style="display: none;">
                <div class="total-row">
                    <span>Total:</span>
                    <span id="cart-total">$0</span>
                </div>
                <a href="pedido.html" class="btn-checkout">Continuar al Pago</a>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const API_URL = 'http://localhost:3000';
        
        // --- INICIO: Script de Gesti칩n de Sesi칩n ---
        const authButtonsContainer = document.querySelector('.header .auth-buttons');
        const token = localStorage.getItem('authToken');
        
        if (token) {
            fetch(API_URL + '/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(response => {
                if (response.ok) return response.json();
                throw new Error('Token inv치lido');
            })
            .then(user => {
                const userEmail = user.email;
                authButtonsContainer.innerHTML = `<span class="user-info" style="color:white; margin-right: 15px; font-weight: 500;">Hola, ${userEmail}</span><button id="logoutBtn" class="btn btn-outline">Cerrar Sesi칩n</button>`;
                document.getElementById('logoutBtn').addEventListener('click', function() {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userEmail');
                    window.location.href = "signin.html";
                });
            })
            .catch(error => {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                mostrarBotonesLogin();
            });
        } else {
            mostrarBotonesLogin();
        }
        
        function mostrarBotonesLogin() {
             authButtonsContainer.innerHTML = `<a href="signin.html" class="btn btn-outline">Iniciar Sesi칩n</a><a href="registro.html" class="btn btn-primary">Registrarse</a>`;
        }
        // --- FIN: Script de Gesti칩n de Sesi칩n ---

        // --- L칍GICA DEL CARRITO ---
        const cartList = document.getElementById('cart-items');
        const cartSummary = document.getElementById('cart-summary');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartTotal = document.getElementById('cart-total');
        
        const formatCurrency = (value) => `$${Math.round(value).toLocaleString('es-CL')}`;
        
        function getCart() {
            return JSON.parse(localStorage.getItem('saborLimeoCart')) || [];
        }
        
        function saveCart(cart) {
            localStorage.setItem('saborLimeoCart', JSON.stringify(cart));
            renderCart(); // Volver a renderizar cada vez que se guarda
        }

        function renderCart() {
            const cart = getCart();
            cartList.innerHTML = ''; // Limpiar lista
            
            if (cart.length === 0) {
                cartSummary.style.display = 'none';
                emptyCartMessage.style.display = 'block';
                return;
            }
            
            cartSummary.style.display = 'block';
            emptyCartMessage.style.display = 'none';
            
            let total = 0;
            
            cart.forEach(item => {
                const li = document.createElement('li');
                li.dataset.id = item.id;
                
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                li.innerHTML = `
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${formatCurrency(item.price)} c/u</span>
                    </div>
                    <div class="item-controls">
                        <button class="btn-cart btn-qty decrease-qty" data-id="${item.id}">-</button>
                        <span class="item-quantity">${item.quantity}</span>
                        <button class="btn-cart btn-qty increase-qty" data-id="${item.id}">+</button>
                        <button class="btn-cart remove-btn" data-id="${item.id}">Eliminar</button>
                    </div>
                `;
                cartList.appendChild(li);
            });
            
            cartTotal.textContent = formatCurrency(total);
        }

        // --- Manejadores de eventos para los botones del carrito ---
        cartList.addEventListener('click', function(e) {
            const target = e.target;
            const id = parseInt(target.dataset.id);
            if (!id) return;

            let cart = getCart();
            const itemIndex = cart.findIndex(item => item.id === id);
            if (itemIndex === -1) return;

            if (target.classList.contains('remove-btn')) {
                cart.splice(itemIndex, 1); // Eliminar el item
            }
            
            if (target.classList.contains('increase-qty')) {
                cart[itemIndex].quantity += 1;
            }
            
            if (target.classList.contains('decrease-qty')) {
                if (cart[itemIndex].quantity > 1) {
                    cart[itemIndex].quantity -= 1;
                } else {
                    // Si la cantidad es 1, eliminarlo (opcional, o dejar en 1)
                    cart.splice(itemIndex, 1);
                }
            }
            
            saveCart(cart); // Guardar cambios y re-renderizar
        });
        
        // Carga inicial
        renderCart();
    });
    </script>

</body>
</html>