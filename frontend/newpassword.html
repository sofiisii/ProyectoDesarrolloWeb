<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperación de Contraseña - Sabor Limeño</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --azul-pacifico: #1E88E5; --azul-pacifico-oscuro: #1565C0; --azul-pacifico-claro: #64B5F6;
            --aji-amarillo: #FFC107; --terracota: #BF360C; --verde-menta: #4CAF50;
            --purpura-nazca: #6A1B9A; --blanco-roto: #F8F9FA; --gris-texto: #424242;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--blanco-roto); color: var(--gris-texto); margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); padding: 1rem 0; }
        .logo { font-size: 1.8rem; font-weight: 700; }
        .recovery-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; padding: 20px 0; }
        .card { max-width: 450px; width: 100%; border-radius: 15px; box-shadow: 0 8px 25px rgba(30, 136, 229, 0.1); border: none; }
        .card-header { background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; padding: 1.5rem; text-align: center; border-bottom: none; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .card-header h2 { margin: 0; font-weight: 600; font-size: 1.5rem; }
        .card-body { padding: 2rem; }
        
        .form-control { border-radius: 8px; border: 2px solid var(--azul-pacifico-claro); padding: 12px 15px; transition: all 0.3s; }
        .form-control:focus { border-color: var(--azul-pacifico); box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2); }
        .form-label { font-weight: 600; color: var(--azul-pacifico-oscuro); margin-bottom: 8px; }
        
        /* Estilos para input con ojo */
        .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .input-group .btn-toggle-password { 
            border: 2px solid var(--azul-pacifico-claro); border-left: none; 
            background-color: white; color: var(--azul-pacifico);
            border-top-right-radius: 8px; border-bottom-right-radius: 8px;
        }
        .input-group .btn-toggle-password:hover { background-color: #f0f8ff; }

        .btn-action { padding: 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; text-decoration: none; display: inline-block; text-align: center; width: 100%; background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); }
        .btn-action:hover:not(:disabled) { background: linear-gradient(135deg, var(--azul-pacifico-oscuro), var(--azul-pacifico)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(30, 136, 229, 0.3); }
        .btn:disabled { background: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
        
        a { color: var(--azul-pacifico-oscuro); text-decoration: none; font-weight: 500; transition: all 0.3s; }
        .alert { border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 2px solid transparent; font-weight: 500; }
        .alert-danger { background-color: rgba(191, 54, 12, 0.15); color: var(--terracota); border-color: var(--terracota); }
        .alert-success { background-color: rgba(76, 175, 80, 0.15); color: var(--verde-menta); border-color: var(--verde-menta); }
        
        .password-match { margin-top: 5px; font-size: 12px; font-weight: 500; }
        .match-error { color: var(--terracota); }
        .match-success { color: var(--verde-menta); }
        
        .security-indicator { display: flex; align-items: center; margin-top: 5px; font-size: 13px; color: var(--gris-texto); transition: color 0.3s; }
        .security-valid { color: var(--verde-menta) !important; font-weight: 600; }
        .security-invalid { color: var(--terracota); }
        .security-icon { margin-right: 6px; width: 15px; text-align: center; }
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <div class="logo">Sabor Limeño</div>
        </div>
    </header>

    <div class="container recovery-container">
        <div class="card">

            <div id="requestView">
                <div class="card-header"><h2>¿Olvidaste tu contraseña?</h2></div>
                <div class="card-body">
                    <div id="requestSuccess" class="alert alert-success d-none" role="alert" style="word-break: break-word;"></div>
                    <div id="requestError" class="alert alert-danger d-none" role="alert"></div>
                    
                    <p class="text-center mb-4">Introduce tu correo para enviarte un enlace de recuperación.</p>
                    
                    <form id="requestForm">
                        <div class="mb-4">
                            <label for="email" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="email" placeholder="tu.correo@ejemplo.com" required>
                        </div>
                        <button type="submit" class="btn-action" id="requestSubmit">Enviar Enlace</button>
                    </form>

                    <div class="text-center mt-3">
                        <a href="signin.html">← Volver al inicio de sesión</a>
                    </div>
                </div>
            </div>

            <div id="resetView" class="d-none">
                <div class="card-header"><h2>Nueva Contraseña</h2></div>
                <div class="card-body">
                    <div id="resetError" class="alert alert-danger d-none" role="alert"></div>
                    <div id="resetSuccess" class="alert alert-success d-none" role="alert">
                        <strong>¡Listo!</strong> Contraseña actualizada. Redirigiendo...
                    </div>
                    
                    <form id="resetForm">
                        <input type="hidden" id="resetTokenInput" value="">
                        
                        <div class="mb-4">
                            <label for="newPassword" class="form-label">Nueva contraseña</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="newPassword" placeholder="Mínimo 8 caracteres" required>
                                <button class="btn btn-toggle-password" type="button" id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            
                            <div class="security-indicators mt-3">
                                <div class="security-indicator" id="lengthIndicator">
                                    <span class="security-icon">⏺</span> Mínimo 8 caracteres
                                </div>
                                <div class="security-indicator" id="uppercaseIndicator">
                                    <span class="security-icon">⏺</span> Una mayúscula (A-Z)
                                </div>
                                <div class="security-indicator" id="numberIndicator">
                                    <span class="security-icon">⏺</span> Un número (0-9)
                                </div>
                                <div class="security-indicator" id="symbolIndicator">
                                    <span class="security-icon">⏺</span> Un símbolo (!@#$...)
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Repite la contraseña" required>
                                <button class="btn btn-toggle-password" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="passwordMatch" class="password-match"></div>
                        </div>

                        <button type="submit" class="btn-action" id="resetSubmit">Guardar Contraseña</button>
                    </form>
                    
                    <div class="text-center mt-3">
                        <a href="newpassword.html" id="requestNewLink">← Solicitar otro enlace</a>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    <footer class="footer" style="background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%); color: white; padding: 3rem 0 1rem; margin-top: 3rem;">
        <div class="container">
            <div class="footer-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                <div class="footer-section">
                    <h3 style="margin-bottom: 1rem; color: var(--aji-amarillo); font-weight: 600;">Sabor Limeño</h3>
                    <p>Auténtica cocina peruana con sabores que cuentan historias. Tradición e innovación en cada plato.</p>
                </div>
                <div class="footer-section">
                    <h3 style="margin-bottom: 1rem; color: var(--aji-amarillo); font-weight: 600;">Sistema Integral</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.5rem;"><a href="signin.html" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">Inicio de Sesión</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="catalogo.html" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">Catálogo Digital</a></li>
                        <li id="link-admin-panel-footer" class="d-none" style="margin-bottom: 0.5rem;"><a href="administracion.html" style="color: var(--aji-amarillo); text-decoration: none;">★ Panel Admin</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3 style="margin-bottom: 1rem; color: var(--aji-amarillo); font-weight: 600;">Gestión Operativa</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 0.5rem;"><a href="pedido.html" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">Gestión de Pedidos</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="delivery.html" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">Seguimiento Delivery</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="anularpedido.html" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">Anular Pedido</a></li>
                        <li style="margin-bottom: 0.5rem;"><a href="boleta.html" style="color: rgba(255, 255, 255, 0.8); text-decoration: none;">Boleta Electrónica</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom" style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.7);">
                <p>&copy; 2025 Sabor Limeño. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const API_URL = 'http://localhost:8000';
            const adminFooterLink = document.getElementById('link-admin-panel-footer');
            
            // Verificar si hay token guardado (por si el usuario llega aquí logueado)
            const savedToken = localStorage.getItem('authToken');
            if (savedToken && adminFooterLink) {
                 fetch(API_URL + '/api/auth/me', { headers: { 'Authorization': `Bearer ${savedToken}` } })
                 .then(res => res.ok ? res.json() : null)
                 .then(user => { if (user && user.role === 'admin') adminFooterLink.classList.remove('d-none'); })
                 .catch(() => {});
            }

            // ... (Resto del código de recuperación de contraseña se mantiene igual) ...
            // Vistas
            const requestView = document.getElementById("requestView");
            const resetView = document.getElementById("resetView");
            const requestForm = document.getElementById("requestForm");
            const resetForm = document.getElementById("resetForm");
            const requestSubmit = document.getElementById("requestSubmit");
            const resetSubmit = document.getElementById("resetSubmit");
            
            // Router
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (token) {
                requestView.classList.add("d-none");
                resetView.classList.remove("d-none");
                document.getElementById("resetTokenInput").value = token;
            } else {
                requestView.classList.remove("d-none");
                resetView.classList.add("d-none");
            }

            // Formulario Solicitud
            requestForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                const email = document.getElementById("email").value;
                requestSubmit.disabled = true; requestSubmit.textContent = 'Enviando...';
                
                try {
                    const res = await fetch(API_URL + '/api/auth/request-password-reset', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        document.getElementById("requestSuccess").classList.remove("d-none");
                        // Generar link local
                        const currentUrl = window.location.href.split('?')[0];
                        document.getElementById("requestSuccess").innerHTML = `<strong>¡Enlace enviado!</strong><br><a href="${currentUrl}?token=${data.simulatedToken}" class="btn btn-primary btn-sm mt-2">RESTABLECER CONTRASEÑA</a>`;
                    } else {
                         document.getElementById("requestError").textContent = data.message;
                         document.getElementById("requestError").classList.remove("d-none");
                    }
                } catch (error) { alert('Error de conexión'); }
                requestSubmit.disabled = false; requestSubmit.textContent = 'Enviar Enlace';
            });

            // Formulario Reset
            resetForm.addEventListener("submit", async function (e) {
                e.preventDefault();
                const newPassword = document.getElementById("newPassword").value;
                const tokenVal = document.getElementById("resetTokenInput").value;
                
                resetSubmit.disabled = true; resetSubmit.textContent = 'Guardando...';
                
                try {
                    const res = await fetch(API_URL + '/api/auth/reset-password', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ token: tokenVal, newPassword })
                    });
                    if (res.ok) {
                        document.getElementById("resetSuccess").classList.remove("d-none");
                        setTimeout(() => window.location.href = "signin.html", 3000);
                    } else {
                        alert('Error al cambiar contraseña');
                    }
                } catch(e) { alert('Error de conexión'); }
                resetSubmit.disabled = false; resetSubmit.textContent = 'Cambiar Contraseña';
            });
        });
    </script>
</body>
</html>