<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperaci√≥n de Contrase√±a - Sabor Lime√±o</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root {
            --azul-pacifico: #1E88E5; --azul-pacifico-oscuro: #1565C0; --azul-pacifico-claro: #64B5F6;
            --aji-amarillo: #FFC107; --terracota: #BF360C; --verde-menta: #4CAF50;
            --purpura-nazca: #6A1B9A; --blanco-roto: #F8F9FA; --gris-texto: #424242;
        }
        body { font-family: 'Open Sans', sans-serif; background-color: var(--blanco-roto); color: var(--gris-texto); margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* HEADER */
        .header { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); padding: 1rem 0; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.8rem; font-weight: 700; }
        .nav-links { display: flex; gap: 2rem; list-style: none; margin:0; padding:0;}
        .nav-links a { color: white; text-decoration: none; font-weight: 600; transition: all 0.3s; padding: 0.5rem 1rem; border-radius: 25px; }
        .nav-links a:hover { background-color: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
        .auth-buttons { display: flex; gap: 1rem; align-items: center; }
        .user-info { color: white; margin-right: 15px; font-weight: 600; }
        .btn-custom { padding: 8px 20px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px; text-decoration: none; display: inline-block; }
        .btn-outline-white { background: transparent; border: 2px solid white; color: white; }
        .btn-outline-white:hover { background: white; color: var(--azul-pacifico); }
        .btn-yellow { background: var(--aji-amarillo); color: var(--azul-pacifico-oscuro); font-weight: 700; }

        /* CARD ESTILOS */
        .recovery-container { display: flex; justify-content: center; align-items: center; flex-grow: 1; padding: 40px 0; }
        .card { max-width: 450px; width: 100%; border-radius: 15px; box-shadow: 0 8px 25px rgba(30, 136, 229, 0.1); border: none; overflow: hidden; background: white; }
        .card-header { background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; padding: 1.5rem; text-align: center; border-bottom: none; }
        .card-header h2 { margin: 0; font-weight: 700; font-size: 1.5rem; }
        .card-body { padding: 2rem; }
        
        .form-control { border-radius: 8px; border: 2px solid var(--azul-pacifico-claro); padding: 12px 15px; transition: all 0.3s; }
        .form-control:focus { border-color: var(--azul-pacifico); box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2); outline: none; }
        .form-label { font-weight: 600; color: var(--azul-pacifico-oscuro); margin-bottom: 8px; }
        
        /* Input Group con Ojo */
        .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none; }
        .input-group .btn-toggle-password { border: 2px solid var(--azul-pacifico-claro); border-left: none; background-color: white; color: var(--azul-pacifico); border-top-right-radius: 8px; border-bottom-right-radius: 8px; transition: all 0.3s; }
        .input-group .btn-toggle-password:hover { background-color: #f0f8ff; }

        .btn-action { padding: 15px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 16px; transition: all 0.3s; width: 100%; background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); margin-top: 10px; }
        .btn-action:hover:not(:disabled) { background: linear-gradient(135deg, var(--azul-pacifico-oscuro), var(--azul-pacifico)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(30, 136, 229, 0.3); }
        .btn:disabled { background: #cccccc; cursor: not-allowed; }
        
        .alert { border-radius: 8px; padding: 15px; margin-bottom: 20px; font-weight: 600; border: none; }
        .alert-danger { background-color: rgba(191, 54, 12, 0.1); color: var(--terracota); border: 1px solid var(--terracota); }
        .alert-success { background-color: rgba(76, 175, 80, 0.1); color: var(--verde-menta); border: 1px solid var(--verde-menta); }
        
        /* Validadores */
        .security-indicators { margin-top: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
        .security-indicator { display: flex; align-items: center; margin-bottom: 5px; font-size: 13px; color: #888; transition: color 0.3s; }
        .security-valid { color: var(--verde-menta) !important; font-weight: 700; }
        .security-icon { margin-right: 8px; width: 15px; text-align: center; }
        .password-match { margin-top: 5px; font-size: 13px; font-weight: 600; }
        .match-error { color: var(--terracota); }
        .match-success { color: var(--verde-menta); }

        /* FOOTER COMPACTO */
        .footer { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%); color: white; padding: 2rem 0 1rem; margin-top: auto; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .footer-section h3 { margin-bottom: 0.8rem; color: var(--aji-amarillo); font-weight: 700; font-size: 1.1rem; }
        .footer-section ul { list-style: none; padding: 0; }
        .footer-section ul li { margin-bottom: 0.4rem; }
        .footer-section a { color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: all 0.3s; font-size: 0.9rem; }
        .footer-section a:hover { color: var(--aji-amarillo); padding-left: 3px; }
        .footer-bottom { text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6); font-size: 0.85rem; }
        .d-none { display: none !important; }
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <nav class="nav-container">
                <div class="logo"><span>Sabor Lime√±o</span></div>
                <ul class="nav-links">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="catalogo.html">Cat√°logo</a></li>
                    <li><a href="pedido.html">Mis Pedidos</a></li>
                    <li><a href="carrito.html" style="color: var(--aji-amarillo); font-weight: 700;">Carrito üõí</a></li>
                </ul>
                <div class="auth-buttons" id="authContainer"></div>
            </nav>
        </div>
    </header>

    <div class="container recovery-container">
        <div class="card">

            <div id="requestView">
                <div class="card-header"><h2>Recuperar Cuenta</h2></div>
                <div class="card-body">
                    <div id="requestSuccess" class="alert alert-success d-none" role="alert" style="word-break: break-word;"></div>
                    <div id="requestError" class="alert alert-danger d-none" role="alert"></div>
                    
                    <p class="text-center mb-4" style="color: #666;">Introduce tu correo para enviarte un enlace de recuperaci√≥n.</p>
                    
                    <form id="requestForm">
                        <div class="mb-4">
                            <label for="email" class="form-label">Correo Electr√≥nico</label>
                            <input type="email" class="form-control" id="email" placeholder="ejemplo@email.com" required>
                        </div>
                        <button type="submit" class="btn-action" id="requestSubmit">Enviar Enlace</button>
                    </form>

                    <div class="text-center mt-3">
                        <a href="signin.html" style="color: var(--azul-pacifico); text-decoration: none; font-weight: 600;">‚Üê Volver al inicio de sesi√≥n</a>
                    </div>
                </div>
            </div>

            <div id="resetView" class="d-none">
                <div class="card-header"><h2>Nueva Contrase√±a</h2></div>
                <div class="card-body">
                    <div id="resetError" class="alert alert-danger d-none" role="alert"></div>
                    <div id="resetSuccess" class="alert alert-success d-none" role="alert">
                        <strong>¬°Listo!</strong> Contrase√±a actualizada. Redirigiendo...
                    </div>
                    
                    <form id="resetForm">
                        <input type="hidden" id="resetTokenInput" value="">
                        
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Nueva contrase√±a</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="newPassword" placeholder="M√≠nimo 8 caracteres" required>
                                <button class="btn btn-toggle-password" type="button" id="toggleNewPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            
                            <div class="security-indicators">
                                <div class="security-indicator" id="lengthIndicator"><span class="security-icon">‚è∫</span> M√≠nimo 8 caracteres</div>
                                <div class="security-indicator" id="uppercaseIndicator"><span class="security-icon">‚è∫</span> Una may√∫scula (A-Z)</div>
                                <div class="security-indicator" id="numberIndicator"><span class="security-icon">‚è∫</span> Un n√∫mero (0-9)</div>
                                <div class="security-indicator" id="symbolIndicator"><span class="security-icon">‚è∫</span> Un s√≠mbolo (!@#$...)</div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="confirmPassword" class="form-label">Confirmar contrase√±a</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Repite la contrase√±a" required>
                                <button class="btn btn-toggle-password" type="button" id="toggleConfirmPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="passwordMatch" class="password-match"></div>
                        </div>

                        <button type="submit" class="btn-action" id="resetSubmit">Guardar Contrase√±a</button>
                    </form>
                    
                    <div class="text-center mt-3">
                        <a href="newpassword.html" id="requestNewLink" style="color: var(--azul-pacifico); font-weight: 600;">‚Üê Solicitar otro enlace</a>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Sabor Lime√±o</h3>
                    <p style="font-size: 0.9rem;">Tradici√≥n y sabor en cada plato.</p>
                </div>
                <div class="footer-section">
                    <h3>Sistema</h3>
                    <ul>
                        <li><a href="signin.html">Inicio de Sesi√≥n</a></li>
                        <li><a href="catalogo.html">Cat√°logo</a></li>
                        <li id="link-admin-panel-footer" class="d-none"><a href="administracion.html" style="color: var(--aji-amarillo);">‚òÖ Admin</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Operaciones</h3>
                    <ul>
                        <li><a href="pedido.html">Pedidos</a></li>
                        <li><a href="delivery.html">Delivery</a></li>
                        <li id="link-secure-support" class="d-none"><a href="newpassword.html">Soporte</a></li>
                        <li><a href="anularpedido.html">Anular</a></li>
                        <li><a href="boleta.html">Boleta</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Sabor Lime√±o.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const API_URL = 'http://localhost:8000';
            const authContainer = document.getElementById('authContainer'); // Puede no existir en esta p√°gina si solo hay logo
            
            // Footer links
            const adminFooterLink = document.getElementById('link-admin-panel-footer');
            const supportLink = document.getElementById('link-secure-support');
            
            // Verificar sesi√≥n actual (solo para Header y Footer)
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                fetch(API_URL + '/api/auth/me', { headers: { 'Authorization': `Bearer ${savedToken}` } })
                .then(res => res.ok ? res.json() : null)
                .then(user => {
                     if(user) {
                         // Si existe el contenedor de auth, mostramos info
                         if(authContainer) {
                            authContainer.innerHTML = `<span class="user-info">Hola, ${user.nombre}!</span><button id="logoutBtn" class="btn-custom btn-outline-white">Cerrar Sesi√≥n</button>`;
                            document.getElementById('logoutBtn').addEventListener('click', () => { localStorage.clear(); window.location.href = "signin.html"; });
                         }
                         // Mostrar opciones Admin
                         if(user.role === 'admin') {
                             if(adminFooterLink) adminFooterLink.classList.remove('d-none');
                             if(supportLink) supportLink.classList.remove('d-none');
                         }
                     } else { showLoginBtn(); }
                })
                .catch(() => showLoginBtn());
            } else { showLoginBtn(); }

            function showLoginBtn() {
                if(authContainer) authContainer.innerHTML = `<a href="signin.html" class="btn-custom btn-outline-white">Iniciar Sesi√≥n</a>`;
            }

            // --- L√ìGICA DE RECUPERACI√ìN ---
            const requestView = document.getElementById("requestView");
            const resetView = document.getElementById("resetView");
            const requestForm = document.getElementById("requestForm");
            const resetForm = document.getElementById("resetForm");
            
            const resetTokenInput = document.getElementById("resetTokenInput");
            const newPassword = document.getElementById("newPassword");
            const confirmPassword = document.getElementById("confirmPassword");
            
            // Router simple
            const urlParams = new URLSearchParams(window.location.search);
            const tokenParam = urlParams.get('token');

            if (tokenParam) {
                requestView.classList.add("d-none");
                resetView.classList.remove("d-none");
                resetTokenInput.value = tokenParam;
            } else {
                requestView.classList.remove("d-none");
                resetView.classList.add("d-none");
            }
            
            // Toggle Password
            function toggleVisibility(input, btn) {
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                btn.querySelector('i').classList.toggle('fa-eye');
                btn.querySelector('i').classList.toggle('fa-eye-slash');
            }
            document.getElementById('toggleNewPassword').addEventListener('click', function() { toggleVisibility(newPassword, this); });
            document.getElementById('toggleConfirmPassword').addEventListener('click', function() { toggleVisibility(confirmPassword, this); });

            // Validadores
            function validateSecurity(p) {
                const valid = p.length >= 8 && /[A-Z]/.test(p) && /\d/.test(p) && /[!@#$%^&*(),.?":{}|<>]/.test(p);
                
                document.getElementById('lengthIndicator').classList.toggle('security-valid', p.length >= 8);
                document.getElementById('uppercaseIndicator').classList.toggle('security-valid', /[A-Z]/.test(p));
                document.getElementById('numberIndicator').classList.toggle('security-valid', /\d/.test(p));
                document.getElementById('symbolIndicator').classList.toggle('security-valid', /[!@#$%^&*(),.?":{}|<>]/.test(p));
                
                return valid;
            }

            newPassword.addEventListener('input', () => validateSecurity(newPassword.value));
            
            confirmPassword.addEventListener('input', () => {
                const match = document.getElementById('passwordMatch');
                if (!confirmPassword.value) { match.textContent = ''; return; }
                if (newPassword.value === confirmPassword.value) {
                    match.textContent = "‚úì Coinciden"; match.className = "password-match match-success";
                } else {
                    match.textContent = "‚úó No coinciden"; match.className = "password-match match-error";
                }
            });

            // Submit Request
            requestForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = document.getElementById("requestSubmit");
                const msg = document.getElementById("requestSuccess");
                const err = document.getElementById("requestError");
                
                btn.disabled = true; btn.textContent = 'Enviando...';
                msg.classList.add("d-none"); err.classList.add("d-none");

                try {
                    const res = await fetch(API_URL + '/api/auth/request-password-reset', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: document.getElementById("email").value })
                    });
                    const data = await res.json();
                    
                    if (res.ok) {
                        // Generar link local real para la demo
                        const currentUrl = window.location.href.split('?')[0];
                        msg.innerHTML = `<strong>¬°Enlace simulado!</strong><br><a href="${currentUrl}?token=${data.simulatedToken}" class="btn btn-primary btn-sm mt-2">RESTABLECER AHORA</a>`;
                        msg.classList.remove("d-none");
                        requestForm.reset();
                    } else {
                        err.textContent = data.message; err.classList.remove("d-none");
                    }
                } catch (error) { err.textContent = 'Error de conexi√≥n.'; err.classList.remove("d-none"); }
                btn.disabled = false; btn.textContent = 'Enviar Enlace';
            });
            
            // Submit Reset
            resetForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const btn = document.getElementById("resetSubmit");
                const msg = document.getElementById("resetSuccess");
                const err = document.getElementById("resetError");

                if (newPassword.value !== confirmPassword.value || !validateSecurity(newPassword.value)) {
                    alert("Verifica la contrase√±a."); return;
                }
                
                btn.disabled = true; btn.textContent = 'Guardando...';
                
                try {
                    const res = await fetch(API_URL + '/api/auth/reset-password', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: resetTokenInput.value, newPassword: newPassword.value })
                    });
                    if (res.ok) {
                        msg.classList.remove("d-none");
                        resetForm.style.display = 'none';
                        setTimeout(() => window.location.href = "signin.html", 3000);
                    } else {
                        const data = await res.json();
                        err.textContent = data.message; err.classList.remove("d-none");
                    }
                } catch(e) { err.textContent = 'Error de conexi√≥n.'; err.classList.remove("d-none"); }
                btn.disabled = false; btn.textContent = 'Guardar Contrase√±a';
            });
        });
    </script>
</body>
</html>