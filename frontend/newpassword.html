<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Recuperación de Contraseña - Sabor Limeño</title>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            :root {
                --azul-pacifico: #1E88E5; --azul-pacifico-oscuro: #1565C0; --azul-pacifico-claro: #64B5F6;
                --aji-amarillo: #FFC107; --terracota: #BF360C; --verde-menta: #4CAF50;
                --purpura-nazca: #6A1B9A; --blanco-roto: #F8F9FA; --gris-texto: #424242;
            }
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--blanco-roto); color: var(--gris-texto); margin: 0; padding: 0; }
            .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
            .header { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); padding: 1rem 0; }
            .logo { font-size: 1.8rem; font-weight: 700; }
            .recovery-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; padding: 20px 0; }
            .card { max-width: 450px; width: 100%; border-radius: 15px; box-shadow: 0 8px 25px rgba(30, 136, 229, 0.1); border: none; }
            .card-header { background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; padding: 1.5rem; text-align: center; border-bottom: none; border-top-left-radius: 15px; border-top-right-radius: 15px; }
            .card-header h2 { margin: 0; font-weight: 600; font-size: 1.5rem; }
            .card-body { padding: 2rem; }
            .form-control { border-radius: 8px; border: 2px solid var(--azul-pacifico-claro); padding: 12px 15px; transition: all 0.3s; }
            .form-control:focus { border-color: var(--azul-pacifico); box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2); }
            .form-label { font-weight: 600; color: var(--azul-pacifico-oscuro); margin-bottom: 8px; }
            .btn-action { padding: 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; text-decoration: none; display: inline-block; text-align: center; width: 100%; background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); }
            .btn-action:hover:not(:disabled) { background: linear-gradient(135deg, var(--azul-pacifico-oscuro), var(--azul-pacifico)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(30, 136, 229, 0.3); }
            .btn:disabled { background: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
            a { color: var(--azul-pacifico-oscuro); text-decoration: none; font-weight: 500; transition: all 0.3s; }
            .alert { border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 2px solid transparent; font-weight: 500; }
            .alert-danger { background-color: rgba(191, 54, 12, 0.15); color: var(--terracota); border-color: var(--terracota); }
            .alert-success { background-color: rgba(76, 175, 80, 0.15); color: var(--verde-menta); border-color: var(--verde-menta); }
            .password-match { margin-top: 5px; font-size: 12px; font-weight: 500; }
            .match-error { color: var(--terracota); }
            .security-indicator { display: flex; align-items: center; margin-top: 5px; font-size: 14px; color: var(--gris-texto); }
            .security-valid { color: var(--verde-menta) !important; }
            .security-invalid { color: var(--terracota); }
        </style>
    </head>
    <body>

        <header class="header">
            <div class="container">
                <div class="logo">
                    <span>Sabor Limeño</span>
                </div>
            </div>
        </header>

        <div class="container recovery-container">
            <div class="card">

                <div id="requestView">
                    <div class="card-header">
                        <h2>¿Olvidaste tu contraseña?</h2>
                    </div>
                    <div class="card-body">
                        <div id="requestSuccess" class="alert alert-success d-none" role="alert">
                            <strong>¡Enlace enviado!</strong> Revisa tu correo electrónico (o la consola del backend) para un enlace temporal.
                        </div>

                        <div id="requestError" class="alert alert-danger d-none" role="alert">
                            </div>
                        
                        <p class="text-center mb-4">Introduce tu correo electrónico para enviarte un enlace temporal.</p>
                        
                        <form id="requestForm">
                            <div class="mb-4">
                                <label for="email" class="form-label">Correo Electrónico</label>
                                <input type="email" class="form-control" id="email" placeholder="tu.correo@ejemplo.com" required>
                            </div>

                            <button type="submit" class="btn-action" id="requestSubmit">Enviar Enlace</button>
                        </form>

                        <div class="text-center mt-3">
                            <a href="signin.html">← Volver al inicio de sesión</a>
                        </div>
                    </div>
                </div>

                <div id="resetView" class="d-none">
                    <div class="card-header">
                        <h2>Establecer Nueva Contraseña</h2>
                    </div>
                    <div class="card-body">
                        
                        <div id="resetError" class="alert alert-danger d-none" role="alert">
                            </div>
                        
                        <div id="resetSuccess" class="alert alert-success d-none" role="alert">
                            <strong>¡Recuperación exitosa!</strong> Tu contraseña ha sido actualizada. Serás redirigido para iniciar sesión.
                        </div>
                        
                        <form id="resetForm">
                            <input type="hidden" id="resetTokenInput" value="">
                        
                            <div class="mb-4">
                                <label for="newPassword" class="form-label">Nueva contraseña</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="Ingresa tu nueva contraseña" required>
                                
                                <div id="passwordError" class="password-match match-error"></div>

                                <div class="security-indicators mt-3">
                                    <div class="security-indicator" id="lengthIndicator">
                                        <span class="security-icon">⏺</span> Al menos 8 caracteres
                                    </div>
                                    <div class="security-indicator" id="uppercaseIndicator">
                                        <span class="security-icon">⏺</span> Incluir mayúsculas
                                    </div>
                                    <div class="security-indicator" id="numberIndicator">
                                        <span class="security-icon">⏺</span> Incluir un número
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirma tu nueva contraseña" required>
                                <div id="passwordMatch" class="password-match"></div>
                            </div>

                            <button type="submit" class="btn-action" id="resetSubmit">Cambiar Contraseña</button>
                        </form>
                        
                        <div class="text-center mt-3">
                            <a href="newpassword.html" id="requestNewLink">← Solicitar un nuevo enlace</a>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                
                const API_URL = 'http://localhost:8000';
                
                // Vistas
                const requestView = document.getElementById("requestView");
                const resetView = document.getElementById("resetView");
                
                // Formulario de Solicitud
                const requestForm = document.getElementById("requestForm");
                const requestSubmit = document.getElementById("requestSubmit");
                const emailInput = document.getElementById("email");
                const requestSuccess = document.getElementById("requestSuccess");
                const requestError = document.getElementById("requestError");
                
                // Formulario de Reseteo
                const resetForm = document.getElementById("resetForm");
                const resetSubmit = document.getElementById("resetSubmit");
                const resetTokenInput = document.getElementById("resetTokenInput");
                const newPassword = document.getElementById("newPassword");
                const confirmPassword = document.getElementById("confirmPassword");
                const resetError = document.getElementById("resetError");
                const resetSuccess = document.getElementById("resetSuccess");
                const passwordError = document.getElementById("passwordError");
                const passwordMatch = document.getElementById("passwordMatch");

                // Indicadores de seguridad
                const lengthIndicator = document.getElementById("lengthIndicator");
                const uppercaseIndicator = document.getElementById("uppercaseIndicator");
                const numberIndicator = document.getElementById("numberIndicator");
                
                // 1. Determinar qué vista mostrar
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                if (token) {
                    // Si hay un token en la URL, mostrar la vista de reseteo
                    requestView.classList.add("d-none");
                    resetView.classList.remove("d-none");
                    resetTokenInput.value = token;
                } else {
                    // Si no, mostrar la vista de solicitud
                    requestView.classList.remove("d-none");
                    resetView.classList.add("d-none");
                }
                
                // 2. Lógica del Formulario de Solicitud (Vista 1)
                requestForm.addEventListener("submit", async function (e) {
                    e.preventDefault();
                    clearMessages();
                    requestSubmit.disabled = true;
                    requestSubmit.textContent = 'Enviando...';

                    try {
                        const response = await fetch(API_URL + '/api/auth/request-password-reset', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: emailInput.value })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            requestSuccess.classList.remove("d-none");
                            requestForm.reset();
                            // SIMULACIÓN: Mostramos el token para la prueba
                            requestSuccess.innerHTML = `<strong>¡Enlace enviado!</strong> (Para probar, usa este token en la URL: <strong>${data.simulatedToken}</strong>)`;
                        } else {
                            requestError.textContent = data.message;
                            requestError.classList.remove("d-none");
                        }
                    } catch (error) {
                        requestError.textContent = 'Error de conexión con el servidor.';
                        requestError.classList.remove("d-none");
                    } finally {
                        requestSubmit.disabled = false;
                        requestSubmit.textContent = 'Enviar Enlace';
                    }
                });
                
                // 3. Lógica del Formulario de Reseteo (Vista 2)
                resetForm.addEventListener("submit", async function (e) {
                    e.preventDefault();
                    clearMessages();

                    // Validaciones del frontend
                    if (newPassword.value !== confirmPassword.value) {
                        passwordError.textContent = "Las contraseñas no coinciden.";
                        return;
                    }
                    if (!validatePasswordSecurity(newPassword.value)) {
                        passwordError.textContent = "La contraseña no cumple los requisitos.";
                        return;
                    }
                    
                    resetSubmit.disabled = true;
                    resetSubmit.textContent = 'Cambiando contraseña...';

                    try {
                        const response = await fetch(API_URL + '/api/auth/reset-password', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                token: resetTokenInput.value,
                                newPassword: newPassword.value 
                            })
                        });
                        
                        const data = await response.json();

                        if (response.ok) {
                            resetSuccess.classList.remove("d-none");
                            resetForm.style.display = 'none';
                            document.getElementById('requestNewLink').style.display = 'none';
                            // Redirigir al login
                            setTimeout(() => {
                                window.location.href = "signin.html";
                            }, 3000);
                        } else {
                            resetError.textContent = data.message; // "Enlace caducado o inválido"
                            resetError.classList.remove("d-none");
                        }
                    } catch (error) {
                        resetError.textContent = 'Error de conexión con el servidor.';
                        resetError.classList.remove("d-none");
                    } finally {
                        resetSubmit.disabled = false;
                        resetSubmit.textContent = 'Cambiar Contraseña';
                    }
                });

                // --- Funciones Helper ---
                
                function clearMessages() {
                    requestSuccess.classList.add("d-none");
                    requestError.classList.add("d-none");
                    resetError.classList.add("d-none");
                    resetSuccess.classList.add("d-none");
                    passwordError.textContent = '';
                    passwordMatch.textContent = '';
                }

                function validatePasswordSecurity(password) {
                    const hasLength = password.length >= 8;
                    const hasUppercase = /[A-Z]/.test(password);
                    const hasNumber = /\d/.test(password);
                    
                    lengthIndicator.classList.toggle('security-valid', hasLength);
                    lengthIndicator.querySelector('.security-icon').textContent = hasLength ? '✓' : '⏺';
                    uppercaseIndicator.classList.toggle('security-valid', hasUppercase);
                    uppercaseIndicator.querySelector('.security-icon').textContent = hasUppercase ? '✓' : '⏺';
                    numberIndicator.classList.toggle('security-valid', hasNumber);
                    numberIndicator.querySelector('.security-icon').textContent = hasNumber ? '✓' : '⏺';
                    
                    return hasLength && hasUppercase && hasNumber;
                }

                newPassword.addEventListener('input', () => validatePasswordSecurity(newPassword.value));
                
                confirmPassword.addEventListener('input', function() {
                    if (newPassword.value && this.value && newPassword.value !== this.value) {
                        passwordMatch.textContent = '✗ Las contraseñas no coinciden';
                        passwordMatch.classList.add('match-error');
                    } else if (newPassword.value === this.value) {
                        passwordMatch.textContent = '✓ Las contraseñas coinciden';
                        passwordMatch.classList.remove('match-error');
                    } else {
                        passwordMatch.textContent = '';
                    }
                });
            });
        </script>
    </body>
</html>