<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Boleta Electr√≥nica - Sabor Lime√±o</title>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            :root {
                --azul-pacifico: #1E88E5; --azul-pacifico-oscuro: #1565C0; --azul-pacifico-claro: #64B5F6;
                --aji-amarillo: #FFC107; --terracota: #BF360C; --verde-menta: #4CAF50;
                --purpura-nazca: #6A1B9A; --blanco-roto: #F8F9FA; --gris-texto: #424242;
            }
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--blanco-roto); color: var(--gris-texto); margin: 0; padding: 0; }
            .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
            .header { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); padding: 1rem 0; }
            .nav-container { display: flex; justify-content: space-between; align-items: center; }
            .logo { font-size: 1.8rem; font-weight: 700; }
            .nav-links { display: flex; gap: 2rem; list-style: none; }
            .nav-links a { color: white; text-decoration: none; font-weight: 500; transition: all 0.3s; padding: 0.5rem 1rem; border-radius: 25px; }
            .nav-links a:hover { background-color: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
            .auth-buttons { display: flex; gap: 1rem; align-items: center; }
            .user-info { color: white; margin-right: 15px; font-weight: 500; }
            .btn { padding: 10px 20px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; font-size: 14px; }
            .btn-outline { background: transparent; border: 2px solid white; color: white; }
            .btn-outline:hover { background: white; color: var(--azul-pacifico); }
            .btn-primary { background: var(--aji-amarillo); color: var(--azul-pacifico-oscuro); font-weight: 700; }
            .btn-primary:hover { background: #FFB300; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); }
            .hero { background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-claro) 100%); color: white; padding: 2rem 0; text-align: center; margin-bottom: 2rem; position: relative; overflow: hidden; }
            .hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(255,255,255,0.1)"/></svg>'); background-size: cover; }
            .hero-content { max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }
            .hero h1 { font-size: 2rem; margin-bottom: 0.5rem; font-weight: 700; }
            .hero p { font-size: 1rem; margin-bottom: 0; opacity: 0.9; }
            .receipt-container { max-width: 700px; margin: 0 auto; padding: 0 15px; }
            .card { border-radius: 15px; box-shadow: 0 8px 25px rgba(30, 136, 229, 0.1); border: 2px solid transparent; transition: all 0.3s ease; overflow: hidden; margin-bottom: 2rem; }
            .card:hover { box-shadow: 0 15px 35px rgba(30, 136, 229, 0.15); border-color: var(--azul-pacifico); }
            .card-header { background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; padding: 1.5rem; text-align: center; border-bottom: none; }
            .card-header h2 { margin: 0; font-weight: 600; font-size: 1.5rem; }
            .card-body { padding: 2rem; }
            .email-confirmation { background-color: rgba(76, 175, 80, 0.15); border: 2px solid var(--verde-menta); border-radius: 10px; padding: 15px; margin-bottom: 25px; text-align: center; color: var(--verde-menta); font-weight: 600; }
            .receipt { border: 2px solid var(--blanco-roto); border-radius: 12px; padding: 25px; background: linear-gradient(135deg, #E3F2FD, #FFFFFF); margin-bottom: 25px; position: relative; overflow: hidden; }
            .receipt::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--azul-pacifico), var(--verde-menta)); }
            .receipt-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--azul-pacifico-claro); }
            .restaurant-name { font-size: 22px; font-weight: 700; color: var(--azul-pacifico-oscuro); margin-bottom: 5px; }
            .receipt-info { font-size: 14px; color: var(--gris-texto); margin-bottom: 5px; }
            .receipt-details { margin-bottom: 20px; }
            .detail-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding: 5px 0; }
            .detail-label { font-weight: 500; color: var(--gris-texto); }
            .detail-value { font-weight: 600; color: var(--azul-pacifico-oscuro); }
            .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .items-table th { text-align: left; padding: 12px 8px; border-bottom: 2px solid var(--azul-pacifico-claro); font-weight: 600; color: var(--azul-pacifico-oscuro); background-color: rgba(30, 136, 229, 0.05); }
            .items-table td { padding: 10px 8px; border-bottom: 1px solid var(--azul-pacifico-claro); }
            .item-name { font-weight: 500; }
            .item-qty, .item-price { text-align: center; }
            .item-total { text-align: right; font-weight: 600; }
            .total-section { background: linear-gradient(135deg, var(--verde-menta), #66BB6A); padding: 20px; border-radius: 8px; margin-top: 20px; font-weight: 600; color: white; display: flex; justify-content: space-between; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); font-size: 18px; }
            .btn-action { padding: 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px; transition: all 0.3s; text-decoration: none; display: inline-block; text-align: center; width: 100%; background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro)); color: white; box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2); margin-bottom: 10px; }
            .btn-action:hover:not(:disabled) { background: linear-gradient(135deg, var(--azul-pacifico-oscuro), var(--azul-pacifico)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(30, 136, 229, 0.3); }
            .btn-secondary { background: linear-gradient(135deg, var(--aji-amarillo), #FFB300); color: var(--azul-pacifico-oscuro); box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2); }
            .btn-secondary:hover:not(:disabled) { background: linear-gradient(135deg, #FFB300, var(--aji-amarillo)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(255, 193, 7, 0.3); }
            .btn-reenviar { background: linear-gradient(135deg, var(--purpura-nazca), #8E24AA); color: white; box-shadow: 0 4px 12px rgba(106, 27, 154, 0.2); }
            .btn-reenviar:hover:not(:disabled) { background: linear-gradient(135deg, #8E24AA, var(--purpura-nazca)); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(106, 27, 154, 0.3); }
            .btn:disabled { background: #cccccc; cursor: not-allowed; transform: none; box-shadow: none; }
            .action-buttons { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
            .action-buttons .btn-action { flex: 1 1 auto; min-width: 180px; }
            .footer-note { text-align: center; margin-top: 20px; font-size: 14px; color: var(--gris-texto); font-style: italic; padding: 15px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05)); border-radius: 8px; border: 2px solid var(--aji-amarillo); }
        
            /* --- NUEVO: Estilos para Carga y Error --- */
            #loadingState { text-align: center; padding: 3rem; font-size: 1.2rem; color: var(--gris-texto); }
            #errorState { text-align: center; padding: 3rem; background-color: rgba(191, 54, 12, 0.1); border: 2px solid var(--terracota); border-radius: 10px; color: var(--terracota); }
            
            @media print {
                .header, .hero, .action-buttons, .email-confirmation, #loadingState, #errorState { display: none !important; }
                body { background: white; margin: 0; padding: 0; }
                .receipt-container { max-width: 100%; margin: 0; padding: 0; }
                .card { box-shadow: none; border: 2px solid #000; }
                .receipt { border: 2px solid #000; }
            }
        </style>
    </head>
    <body>

        <header class="header">
            <div class="container">
                <nav class="nav-container">
                    <div class="logo"><span>Sabor Lime√±o</span></div>
                    <ul class="nav-links">
                        <li><a href="index.html">Inicio</a></li>
                        <li><a href="catalogo.html">Cat√°logo</a></li>
                        <li><a href="pedido.html">Mis Pedidos</a></li>
                        <li>
                            <a href="carrito.html" style="color: var(--aji-amarillo); font-weight: 700;">
                                Carrito üõí
                            </a>
                        </li>
                    </ul>
                    <div class="auth-buttons">
                        </div>
                </nav>
            </div>
        </header>
        <section class="hero">
            <div class="container">
                <div class="hero-content">
                    <h1>Boleta Electr√≥nica</h1>
                    <p>Confirmaci√≥n de tu compra en Sabor Lime√±o</p>
                </div>
            </div>
        </section>

        <div class="receipt-container">
            <div class="card">
                <div class="card-header">
                    <h2>Comprobante de Pago</h2>
                </div>
                <div class="card-body">
                
                    <div id="loadingState">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando boleta...</p>
                    </div>

                    <div id="errorState" style="display: none;">
                        <h3>‚ùå Error al cargar la boleta</h3>
                        <p id="errorText">No se pudo encontrar el pedido o no tienes permiso para verlo.</p>
                        <a href="index.html" class="btn-action">Volver al Inicio</a>
                    </div>
                    
                    <div id="boletaContent" style="display: none;">
                        <div class="email-confirmation">
                            Recibir√° un correo electr√≥nico con la boleta adjunta en formato PDF.
                        </div>

                        <div class="receipt">
                            <div class="receipt-header">
                                <div class="restaurant-name">Sabor Lime√±o</div>
                                <div class="receipt-info">RUT: 76.123.456-7</div>
                                <div class="receipt-info" id="boletaNumero">Boleta Electr√≥nica N¬∞ B-2024-00000</div>
                                <div class="receipt-info" id="boletaFecha">Fecha: --/--/---- --:--:--</div>
                            </div>

                            <div class="receipt-details">
                                <div class="detail-row">
                                    <span class="detail-label">Cliente:</span>
                                    <span class="detail-value" id="clientName">Cargando...</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Email:</span>
                                    <span class="detail-value" id="clientEmail">Cargando...</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Direcci√≥n:</span>
                                    <span class="detail-value" id="clientAddress">Cargando...</span>
                                </div>
                            </div>

                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th class="item-qty">Cant</th>
                                        <th class="item-price">P.Unit</th>
                                        <th class="item-total">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="boletaItems">
                                    </tbody>
                            </table>

                            <div class="total-section">
                                <span>TOTAL:</span>
                                <span id="boletaTotal">$0</span>
                            </div>

                            <div class="footer-note">
                                ¬°Gracias por su compra!
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-action btn-reenviar" id="reenviarBtn">üîÑ Reenviar Boleta</button>
                            <button class="btn-action btn-secondary" id="downloadBtn">üì• Descargar PDF</button>
                            <button class="btn-action btn-secondary" id="printBtn">üñ®Ô∏è Imprimir Boleta</button>
                            <button class="btn-action" id="okBtn">Volver al Inicio</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', async function() {
            
            const API_URL = 'http://localhost:8000';
            const token = localStorage.getItem('authToken');

            // Elementos del DOM
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const errorText = document.getElementById('errorText');
            const boletaContent = document.getElementById('boletaContent');
            
            // --- INICIO: Script de Gesti√≥n de Sesi√≥n ---
            const authButtonsContainer = document.querySelector('.header .auth-buttons');
            if (authButtonsContainer) {
                if (token) {
                    const userNombre = localStorage.getItem('userNombre') || 'usuario'; // Usamos el guardado
                    authButtonsContainer.innerHTML = `<span class="user-info" style="color:white; margin-right: 15px; font-weight: 500;">Hola, ${userNombre}!</span><button id="logoutBtn" class="btn btn-outline">Cerrar Sesi√≥n</button>`;
                    
                    const logoutBtn = document.getElementById('logoutBtn');
                    if(logoutBtn) {
                        logoutBtn.addEventListener('click', function() {
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('userNombre');
                            window.location.href = "signin.html";
                        });
                    }
                } else {
                    authButtonsContainer.innerHTML = `<a href="signin.html" class="btn btn-outline">Iniciar Sesi√≥n</a><a href="registro.html" class="btn btn-primary">Registrarse</a>`;
                }
            }
            // --- FIN: Script de Gesti√≥n de Sesi√≥n ---

            // --- L√ìGICA DE CARGA DE BOLETA ---

            // 1. Obtener el ID del pedido desde la URL
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                showError("No se especific√≥ un n√∫mero de pedido.");
                return;
            }
            
            if (!token) {
                showError("Necesitas <a href='signin.html?redirect=boleta.html?orderId=" + orderId + "'>iniciar sesi√≥n</a> para ver esta boleta.");
                return;
            }

            // 2. Buscar los datos del pedido en el backend
            try {
                const response = await fetch(`${API_URL}/api/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || "Error al cargar el pedido.");
                }
                
                // 3. Poblar la boleta con los datos
                populateBoleta(data);
                
                // 4. Mostrar el contenido
                loadingState.style.display = 'none';
                boletaContent.style.display = 'block';

            } catch (error) {
                console.error("Error al cargar la boleta:", error);
                showError(error.message);
            }

            // --- Funciones de la p√°gina ---

            function populateBoleta(orderData) {
                // Formatear moneda
                const formatCurrency = (value) => `$${Math.round(value).toLocaleString('es-CL')}`;
                
                // Formatear fecha
                const formatDate = (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleString('es-CL');
                }

                // Encabezado
                document.getElementById('boletaNumero').textContent = `Boleta Electr√≥nica N¬∞ B-2024-000${orderData.id}`;
                document.getElementById('boletaFecha').textContent = `Fecha: ${formatDate(orderData.createdAt)}`;
                
                // Cliente
                document.getElementById('clientName').textContent = orderData.clientName;
                document.getElementById('clientEmail').textContent = orderData.clientEmail;
                document.getElementById('clientAddress').textContent = orderData.deliveryAddress || 'Sin direcci√≥n';

                // Items
                const itemsTbody = document.getElementById('boletaItems');
                itemsTbody.innerHTML = ''; // Limpiar
                orderData.items.forEach(item => {
                    const itemTotal = item.quantity * item.priceAtPurchase;
                    const row = `
                        <tr>
                            <td class="item-name">${item.productName}</td>
                            <td class="item-qty">${item.quantity}</td>
                            <td class="item-price">${formatCurrency(item.priceAtPurchase)}</td>
                            <td class="item-total">${formatCurrency(itemTotal)}</td>
                        </tr>
                    `;
                    itemsTbody.innerHTML += row;
                });
                
                // Total
                document.getElementById('boletaTotal').textContent = formatCurrency(orderData.totalAmount);
            }
            
            function showError(message) {
                loadingState.style.display = 'none';
                errorText.innerHTML = message; // Usamos innerHTML para el enlace
                errorState.style.display = 'block';
            }

            // (El resto de botones mantiene su funcionalidad de simulaci√≥n)
            const okBtn = document.getElementById('okBtn');
            const printBtn = document.getElementById('printBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const reenviarBtn = document.getElementById('reenviarBtn');
            
            okBtn.addEventListener('click', () => window.location.href = 'index.html');
            printBtn.addEventListener('click', () => window.print());
            
            downloadBtn.addEventListener('click', () => {
                alert('Simulaci√≥n: Boleta descargada en formato PDF exitosamente');
            });
            
            reenviarBtn.addEventListener('click', () => {
                const email = document.getElementById('clientEmail').textContent;
                alert(`Simulaci√≥n: Boleta reenviada exitosamente al correo: ${email}`);
            });
        });
        </script>
    </body>
</html>