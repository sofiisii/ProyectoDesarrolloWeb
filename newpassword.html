<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Recuperación de Contraseña - Sabor Limeño</title>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            /* [ ... ESTILOS CSS REUTILIZADOS SIN CAMBIOS IMPORTANTES ... ] */
            :root {
                --azul-pacifico: #1E88E5;
                --azul-pacifico-oscuro: #1565C0;
                --azul-pacifico-claro: #64B5F6;
                --aji-amarillo: #FFC107;
                --terracota: #BF360C;
                --verde-menta: #4CAF50;
                --purpura-nazca: #6A1B9A;
                --blanco-roto: #F8F9FA;
                --gris-texto: #424242;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: var(--blanco-roto);
                color: var(--gris-texto);
                margin: 0;
                padding: 0;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 20px;
            }
            
            /* Header */
            .header {
                background: linear-gradient(135deg, var(--azul-pacifico) 0%, var(--azul-pacifico-oscuro) 100%);
                color: white;
                box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2);
                padding: 1rem 0;
            }
            
            .logo {
                font-size: 1.8rem;
                font-weight: 700;
            }

            /* Secciones de formulario */
            .recovery-container {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 80vh; 
                padding: 20px 0;
            }

            .card {
                max-width: 450px;
                width: 100%;
                border-radius: 15px;
                box-shadow: 0 8px 25px rgba(30, 136, 229, 0.1);
                border: none;
            }

            .card-header {
                background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro));
                color: white;
                padding: 1.5rem;
                text-align: center;
                border-bottom: none;
                border-top-left-radius: 15px;
                border-top-right-radius: 15px;
            }

            .card-header h2 {
                margin: 0;
                font-weight: 600;
                font-size: 1.5rem;
            }

            .card-body {
                padding: 2rem;
            }

            .form-control {
                border-radius: 8px;
                border: 2px solid var(--azul-pacifico-claro);
                padding: 12px 15px;
                transition: all 0.3s;
            }

            .form-control:focus {
                border-color: var(--azul-pacifico);
                box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
            }

            .form-label {
                font-weight: 600;
                color: var(--azul-pacifico-oscuro);
                margin-bottom: 8px;
            }

            .btn-action { /* Clase unificada para botones */
                padding: 15px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                font-size: 16px;
                transition: all 0.3s;
                text-decoration: none;
                display: inline-block;
                text-align: center;
                width: 100%;
                background: linear-gradient(135deg, var(--azul-pacifico), var(--azul-pacifico-oscuro));
                color: white;
                box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2);
            }

            .btn-action:hover:not(:disabled) {
                background: linear-gradient(135deg, var(--azul-pacifico-oscuro), var(--azul-pacifico));
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(30, 136, 229, 0.3);
            }

            .btn:disabled {
                background: #cccccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            a {
                color: var(--azul-pacifico-oscuro);
                text-decoration: none;
                font-weight: 500;
                transition: all 0.3s;
            }

            .alert {
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 20px;
                border: 2px solid transparent;
                font-weight: 500;
            }

            .alert-danger {
                background-color: rgba(191, 54, 12, 0.15);
                color: var(--terracota);
                border-color: var(--terracota);
            }

            .alert-success {
                background-color: rgba(76, 175, 80, 0.15);
                color: var(--verde-menta);
                border-color: var(--verde-menta);
            }
            
            /* Estilos específicos para restablecimiento (Escenario 3) */
            .password-match {
                margin-top: 5px;
                font-size: 12px;
                font-weight: 500;
            }
            .match-error { color: var(--terracota); }

            .security-indicator {
                display: flex;
                align-items: center;
                margin-top: 5px;
                font-size: 14px;
                color: var(--gris-texto);
            }

            .security-valid {
                color: var(--verde-menta) !important;
            }

            .security-invalid {
                color: var(--terracota);
            }
        </style>
    </head>
    <body>

        <header class="header">
            <div class="container">
                <div class="logo">
                    <span>Sabor Limeño</span>
                </div>
            </div>
        </header>

        <div class="container recovery-container">
            <div class="card">

                <div id="requestView">
                    <div class="card-header">
                        <h2>¿Olvidaste tu contraseña?</h2>
                    </div>
                    <div class="card-body">
                        <div id="requestSuccess" class="alert alert-success d-none" role="alert">
                            <strong>¡Enlace enviado!</strong> Revisa tu correo electrónico para un enlace temporal.
                        </div>

                        <div id="requestError" class="alert alert-danger d-none" role="alert">
                            <strong>Error:</strong> No existe una cuenta asociada a este correo.
                        </div>
                        
                        <p class="text-center mb-4">Introduce tu correo electrónico para enviarte un enlace temporal.</p>
                        
                        <form id="requestForm">
                            <div class="mb-4">
                                <label for="email" class="form-label">Correo Electrónico</label>
                                <input type="email" class="form-control" id="email" placeholder="tu.correo@ejemplo.com" required>
                            </div>

                            <button type="submit" class="btn-action" id="requestSubmit">Enviar Enlace</button>
                        </form>

                        <div class="text-center mt-3">
                            <a href="signin.html">← Volver al inicio de sesión</a>
                        </div>
                    </div>
                </div>

                <div id="resetView" class="d-none">
                    <div class="card-header">
                        <h2>Establecer Nueva Contraseña</h2>
                    </div>
                    <div class="card-body">

                        <div id="expiredMessage" class="alert alert-danger d-none" role="alert">
                            <strong>Enlace caducado:</strong> El enlace ha caducado. Por favor, solicita uno nuevo.
                        </div>
                        
                        <div id="resetSuccess" class="alert alert-success d-none" role="alert">
                            <strong>¡Recuperación exitosa!</strong> Tu contraseña ha sido actualizada. Puedes iniciar sesión con la nueva contraseña.
                        </div>
                        
                        <form id="resetForm">
                            <div class="mb-4">
                                <label for="newPassword" class="form-label">Nueva contraseña</label>
                                <input type="password" class="form-control" id="newPassword" placeholder="Ingresa tu nueva contraseña" required>
                                
                                <div id="passwordError" class="password-match match-error"></div>

                                <div class="security-indicators mt-3">
                                    <div class="security-indicator" id="lengthIndicator">
                                        <span class="security-icon">⏺</span>
                                        Al menos 8 caracteres
                                    </div>
                                    <div class="security-indicator" id="uppercaseIndicator">
                                        <span class="security-icon">⏺</span>
                                        Incluir mayúsculas
                                    </div>
                                    <div class="security-indicator" id="numberIndicator">
                                        <span class="security-icon">⏺</span>
                                        Incluir un número
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="confirmPassword" class="form-label">Confirmar contraseña</label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="Confirma tu nueva contraseña" required>
                                <div id="passwordMatch" class="password-match"></div>
                            </div>

                            <button type="submit" class="btn-action" id="resetSubmit">Cambiar Contraseña</button>
                        </form>
                        
                        <div class="text-center mt-3">
                            <a href="#" onclick="showRequestView(); return false;">← Solicitar un nuevo enlace</a>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Elementos DOM
                const requestView = document.getElementById("requestView");
                const resetView = document.getElementById("resetView");
                const requestForm = document.getElementById("requestForm");
                const resetForm = document.getElementById("resetForm");
                const requestSubmit = document.getElementById("requestSubmit");
                const resetSubmit = document.getElementById("resetSubmit");
                
                // Mensajes de Solicitud
                const requestSuccess = document.getElementById("requestSuccess");
                const requestError = document.getElementById("requestError");
                
                // Mensajes de Restablecimiento
                const expiredMessage = document.getElementById("expiredMessage");
                const resetSuccess = document.getElementById("resetSuccess");

                // Inputs de Restablecimiento
                const newPassword = document.getElementById("newPassword");
                const confirmPassword = document.getElementById("confirmPassword");
                const passwordError = document.getElementById("passwordError");
                const passwordMatch = document.getElementById("passwordMatch");
                
                // Inputs de Solicitud
                const emailInput = document.getElementById("email");

                // Indicadores de seguridad
                const lengthIndicator = document.getElementById("lengthIndicator");
                const uppercaseIndicator = document.getElementById("uppercaseIndicator");
                const numberIndicator = document.getElementById("numberIndicator");

                // *** VARIABLES DE SIMULACIÓN PARA LOS ESCENARIOS ***
                const REGISTERED_EMAIL = "usuario@saborlimeno.com";
                // Simula el estado de uso del token (para Escenario 1 y su supuesto)
                let tokenIsActive = false; 

                // Determina la vista inicial: si la URL tiene un token, muestra Restablecimiento
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');

                function clearMessages() {
                    requestSuccess.classList.add("d-none");
                    requestError.classList.add("d-none");
                    expiredMessage.classList.add("d-none");
                    resetSuccess.classList.add("d-none");
                    passwordError.textContent = '';
                }
                
                // --- Funciones de navegación entre vistas ---

                function showResetView() {
                    requestView.classList.add("d-none");
                    resetView.classList.remove("d-none");
                    clearMessages();
                    // Simulación de token caducado (Escenario 1)
                    if (!tokenIsActive) {
                        expiredMessage.textContent = 'El enlace ha caducado';
                        expiredMessage.classList.remove("d-none");
                        resetSubmit.disabled = true;
                        resetForm.style.display = "none";
                    } else {
                        resetSubmit.disabled = false;
                        resetForm.style.display = "block";
                    }
                }

                window.showRequestView = function() {
                    resetView.classList.add("d-none");
                    requestView.classList.remove("d-none");
                    clearMessages();
                    // Resetea el estado visual de la Solicitud
                    requestSubmit.disabled = false;
                    requestSubmit.textContent = 'Enviar Enlace';
                }
                
                // Inicializar la vista
                if (token) {
                    showResetView();
                } else {
                    showRequestView();
                }

                // --- Lógica del Formulario de Solicitud (Escenario 4 & 5) ---

                requestForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    clearMessages();

                    const email = emailInput.value.trim().toLowerCase();
                    
                    requestSubmit.disabled = true;
                    requestSubmit.textContent = 'Enviando...';

                    setTimeout(() => {
                        requestSubmit.disabled = false;
                        requestSubmit.textContent = 'Enviar Enlace';

                        if (email === REGISTERED_EMAIL) {
                            // ESCENARIO 4: Solicitud de recuperación Exitosa
                            requestSuccess.classList.remove("d-none");
                            // Simulación de envío de email y recarga para probar el token
                            alert("Simulación: Se ha enviado un enlace a su correo. Pulse Aceptar y recargue la página añadiendo ?token=valido a la URL para continuar.");
                            
                        } else {
                            // ESCENARIO 5: Correo no registrado
                            requestError.classList.remove("d-none");
                        }
                    }, 1500); 
                });

                // --- Lógica del Formulario de Restablecimiento (Escenario 1, 2, 3) ---

                function updateSecurityIndicators(password) {
                    const hasLength = password.length >= 8;
                    const hasUppercase = /[A-Z]/.test(password);
                    const hasNumber = /\d/.test(password);
                    
                    lengthIndicator.classList.toggle('security-valid', hasLength);
                    lengthIndicator.querySelector('.security-icon').textContent = hasLength ? '✓' : '⏺';
                    
                    uppercaseIndicator.classList.toggle('security-valid', hasUppercase);
                    uppercaseIndicator.querySelector('.security-icon').textContent = hasUppercase ? '✓' : '⏺';
                    
                    numberIndicator.classList.toggle('security-valid', hasNumber);
                    numberIndicator.querySelector('.security-icon').textContent = hasNumber ? '✓' : '⏺';
                }

                // Validación en tiempo real (requisitos y coincidencia)
                newPassword.addEventListener('input', () => {
                    updateSecurityIndicators(newPassword.value);
                    passwordError.textContent = ''; // Limpiar error de seguridad al escribir
                });

                confirmPassword.addEventListener('input', function() {
                    if (newPassword.value && this.value && newPassword.value !== this.value) {
                        passwordMatch.textContent = '✗ Las contraseñas no coinciden';
                        passwordMatch.classList.add('match-error');
                    } else if (newPassword.value === this.value) {
                        passwordMatch.textContent = '✓ Las contraseñas coinciden';
                        passwordMatch.classList.remove('match-error');
                    } else {
                        passwordMatch.textContent = '';
                    }
                });

                resetForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    clearMessages();

                    if (!tokenIsActive) {
                        // Previene el envío si se detectó token expirado
                        return; 
                    }

                    const newPass = newPassword.value;
                    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
                    
                    // SCENARIO 3: Contraseña insegura
                    if (!passwordRegex.test(newPass)) {
                        passwordError.textContent = "La contraseña debe tener al menos 8 caracteres, una mayúscula y un número"; // Mensaje de Gherkin
                        return;
                    }

                    if (newPass !== confirmPassword.value) {
                        passwordError.textContent = "Las contraseñas no coinciden.";
                        return;
                    }
                    
                    // Deshabilitar botón
                    resetSubmit.disabled = true;
                    resetSubmit.textContent = 'Cambiando contraseña...';

                    // SCENARIO 2: Recuperación Exitosa
                    setTimeout(() => {
                        // Simulación de que el token se invalida tras el uso (Supuesto: se invalida tras uso)
                        tokenIsActive = false; 
                        
                        resetForm.style.display = "none";
                        resetSuccess.classList.remove("d-none");
                        
                        // Redirigir al inicio de sesión simulado
                        setTimeout(() => {
                            window.location.href = "signin.html"; 
                        }, 2000);
                    }, 1500);
                });
            });
        </script>
    </body>
</html>